<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>Audio Spectrum Analyzer</title>    
</head>
<body>
    <div class="container">
            <h1>Audio Spectrum Analyzer</h1>
            <div>nejimon.raveendran</div>
            <h2>Web Display Configuration</h2>            
            <div id="msg"></div>
            <div class="header">
            <div class="menucontainer">
                <div>configuration</div>
                <div class="menu">
                    <a href="index.html" title="Home"><i class="fa-solid fa-house"></i></i></a>  
                    <a href="led-display-config.html" title="LED Display Config"><i class="fa-regular fa-circle-dot"></i></a>  
                    <a href="console-display-config.html" title="Console Display Config"><i class="fa-regular fa-window-maximize"></i></a>    
                </div>
            </div>    
        </div>

        <div class="line"></div>
        

        <div class="content">
            <!--  -->
        </div>      
        <hr>  
    </div>

    <script src="Helpers.js"></script>
    <script src="HttpClient.js"></script>
    <script>
        let _displayType = {
            LED: 1,
            CONSOLE: 2,
            WEB: 3
        };

        let _httpClient = new HttpClient();

        let _webDisplayConfig;
        $(document).ready(() => {
            _webDisplayConfig = new DisplayConfig('.content', new Helpers(), _httpClient, _displayType.WEB);
            _webDisplayConfig.loadConfig();
        });



        class DisplayConfig  {
            constructor(parentElement, helpers, httpClient, displayType) {
                this._httpClient = httpClient;
                this._displayType = displayType;
                this._helpers = helpers;

                //configurable properties
                this._rows = 0;                
                this._cols = 6;
                this._brightness = 0;
                this._transitionSpeed = 0;
                this._peakWait = 0;
                this._peakWaitCountDown = 0;
                this._amplificationFactor = 0;
                this._showPeaks = true;
                this._showPeaksWhenSilent = false;
                this._isBrightnessSupported = false;
                this._pixelColors = [];
                this._peakColor = this._helpers.rgbToHexString(255, 255, 255); 

                //non-configurable properties
                this._parentElement = parentElement;
                this._winWid = window.innerWidth;
                this._winHgt = window.innerHeight;
                this._tblMatrixId = 'tblMatrix';
                this._gradientTopId = 'gradientTop';
                this._gradientBottomId = 'gradientBottom';
                this._blackPixel = 'black'; 
                this._pixelWid = this._winWid / (this._cols * 2);
                this._pixelHgt =  this._pixelWid;
                this._html = '';    
                this._gradient = [];   
                this._configBaseUrl = 'http://10.0.0.16:8090/api/config'; 

                // this.buildConfigUi();
            }

            loadConfig() {
                let configUrl = this._configBaseUrl + '?displayType=' + this._displayType;
                this._httpClient.get(configUrl)
                    .then((config) => {
                        console.log(config);
                        
                        this._config = config;
                        this._rows = config.Rows;
                        this._cols = config.Cols;
                        this._brightnessMin = config.BrightnessMin;
                        this._brightness = config.Brightness;
                        this._brightnessMax = config.BrightnessMax;
                        this._transitionSpeedMin = config.TransitionSpeedMin;
                        this._transitionSpeed = config.TransitionSpeed;
                        this._transitionSpeedMax = config.TransitionSpeedMax;
                        this._peakWaitMin = config.PeakWaitMin;
                        this._peakWait = config.PeakWait;
                        this._peakWaitMax = config.PeakWaitMax;
                        this._peakWaitCountDownMin = config.PeakWaitCountDownMin;
                        this._peakWaitCountDown = config.PeakWaitCountDown;
                        this._peakWaitCountDownMax = config.PeakWaitCountDownMax;
                        this._amplificationFactorMin = config.AmplificationFactorMin;
                        this._amplificationFactor = config.AmplificationFactor;
                        this._amplificationFactorMax = config.AmplificationFactorMax;
                        this._showPeaks = config.ShowPeaks;
                        this._showPeaksWhenSilent = config.ShowPeaksWhenSilent;
                        this._isBrightnessSupported = config.IsBrightnessSupported;
                        this._peakColor = this._helpers.rgbToHexString(config.PeakColor.R, config.PeakColor.G, config.PeakColor.B); //'#010000';// `#${config.PeakColor.Name}`;
                        this._pixelColors = config.PixelColors;
                        
                        this._pixelWid = this._winWid / (this._cols * 2);
                        this._pixelHgt =  this._pixelWid;
                        
                        this.buildConfigUi();

                    })
                    .catch((error) => {
                        console.error('Error loading configuration:', error);
                    });
            }

            saveConfig(newConfig) {
                //
            }

            buildConfigUi(){
                this._html = `<div id="configContainer" style="width: 100%; display: flex; flex-direction: column; align-items: center; padding: 10px;">`;
                this._html = this.buildSliders();
                this._html = this.buildToggles();
                this._html = this.builPeakColor();
                this._html = this.buildMatrix();
                this._html = this.buildDeployButton();
                this._html += `</div>`;

                $(this._parentElement).html(this._html);

                $(`#${this._gradientTopId}`).on('change', this.setGradient.bind(this));
                $(`#${this._gradientBottomId}`).on('change', this.setGradient.bind(this));
                                
            }

            setGradient() {
                let topColor = $(`#${this._gradientTopId}`).val();
                let bottomColor = $(`#${this._gradientBottomId}`).val();
                this._gradient = this._helpers.generateGradient(bottomColor, topColor, this._rows);
                
                for (let x = 0; x < this._cols; x++) {
                    for (let y = 0; y < this._rows; y++) {
                        let pixel = $(`#${this._tblMatrixId} tbody tr td div input[data-px-x=${x}][data-px-y=${y}].pixel`); 
                        $(pixel).val(this._gradient[y]);
                    }
                }
            }

            buildSliders(){
                this._html += `<div id="slidersContainer" style="width: 100%; display: flex; flex-direction: column; align-items: start; padding: 10px;">`;
                this._html += `<label>Peak wait</label>`;
                this._html += `<input id="sldPeakWait" type="range" min="${this._peakWaitMin}" max="${this._peakWaitMax}" step="1" value="${this._peakWait}" style="width:100%;margin-bottom:20px;"/>`;
                
                this._html += `<label>Peak speed</label>`;
                this._html += `<input id="sldPeakFalldown" type="range" min="${this._peakWaitCountDownMin}" max="${this._peakWaitCountDownMax}" step="1" value="${this._peakWaitCountDown}" style="width:100%;margin-bottom:20px;"/>`;
                
                this._html += `<label>Level smoothness</label>`;
                this._html += `<input id="sldTransitionSpeed" type="range" min="${this._transitionSpeedMin}" max="${this._transitionSpeedMax}" step="1" value="${this._transitionSpeed}" style="width:100%;margin-bottom:20px;"/>`;
                
                this._html += `<label>Level strength</label>`;
                this._html += `<input id="sldAmplification" type="range" min="${this._amplificationFactorMin}" max="${this._amplificationFactorMax}" step="1" value="${this._amplificationFactor}" style="width:100%;margin-bottom:20px;"/>`;

                if(this._isBrightnessSupported){
                    this._html += `<label>Brightness</label>`;
                    this._html += `<input id="sldBrightness" type="range" min="${this._brightnessMin}" max="${this._brightnessMax}" step="1" value="${this._brightness}" style="width:100%;margin-bottom:20px;"/>`;
                }
                else {
                    this._html += `<input id="sldBrightness" type="range" min="0" max="0" step="0" value="0" style="width:100%;margin-bottom:20px;display:none;" disabled/>`;
                }

                this._html += `</div>`;
                return this._html;
            }

            buildToggles(){
                this._html += `<div id="togglesContainer" style="width: 100%; display: flex; flex-direction: row; align-items: start; padding-left: 20px;">`;
                this._html += `<input id="chkShowPeak" type="checkbox" ${this._showPeaks ? "checked" : ""}/>`;
                this._html += `<label>Show peaks</label>`;

                this._html += `<input id="chkShowPeaksWhenSilent" type="checkbox" style="margin-left: 50px;" ${this._showPeaksWhenSilent ? "checked" : ""}/>`;
                this._html += `<label>Show bttom peaks when silent</label>`;

                this._html += `</div>`;
                return this._html;
            }


            builPeakColor() {
                this._html += `<div id="peakColorContainer" style="width: 100%; display: flex; flex-direction: column; align-items: center; padding:10px;">`;
                this._html += `<label>Peak Color</label>`;
                this._html += `<div style="width:${this._pixelWid}px;height:${this._pixelHgt}px;overflow:hidden;border-radius:20%;">`;
                this._html += `<input type="color" id="peakColor" value="${this._peakColor}" style="cursor:pointer;width:${this._pixelWid * 3}px; height:${this._pixelHgt * 3}px; transform:translate(-50%, -50%);"/>`;
                this._html += `</div>`;
                this._html += `</div>`;
                return this._html;
            }

            buildMatrix() {
                let gradientPickerHeight = (this._pixelHgt * this._rows) / 2;
                
                this._html += `<div id="peakColorContainer" style="width: 100%; display: flex; flex-direction: column; align-items: center; padding:10px;">`;
                this._html += `<label>Pixel Colors</label>`;
                this._html += `<table id="${this._tblMatrixId}">`;
                this._html += `<tbody>`;

                for (let y = this._rows-1; y >= 0; y--) {  
                    this._html += '<tr>';
                    
                    //build gradient color pickers
                    if (y == this._rows-1) { 
                        this._html += `<td rowspan="${this._rows}">`;
                        this._html += `<p><i class="fa-solid fa-fill-drip"></i></p>`;
                        this._html += `<div><input id="${this._gradientTopId}" type="color" value="#ffffff" style="height:${gradientPickerHeight}px; width:30px;cursor:pointer;"/></div>`;
                        this._html += `<div><input id="${this._gradientBottomId}" type="color" value="#ffffff" style="height:${gradientPickerHeight}px; width:30px;cursor:pointer;"/></div>`;
                        this._html += `</td>`;
                    }


                    //build pixels
                    for (let x = 0; x < this._cols; x++) {
                        let color = this._pixelColors[x][y];
                        let colorHexString = this._helpers.rgbToHexString(color.R, color.G, color.B);
                        this._html += `<td>
                        <div style="width:${this._pixelWid}px;height:${this._pixelHgt}px;overflow:hidden;cursor:pointer;border-radius:20%;">
                        <input type="color" value="${colorHexString}" data-px-x="${x}" data-px-y="${y}"
                        class="pixel"  
                        style=" 
                        width:${this._pixelWid*3}px;
                        height:${this._pixelWid*3}px;
                        cursor: pointer;
                        transform: translate(-50%, -50%);
                        "></input>
                        </div>
                        </td>`;

                    }

                    this._html += '</tr>';
                }

                this._html += `</tbody>`;
                this._html += '</table>';
                this._html += `</div>`;

                return this._html;
            }

            buildDeployButton(){
                this._html += `<div id="deployButtonContainer" style="width: 100%; display: flex; flex-direction: row; justify-content: center; margin-top: 20px;">`;
                this._html += `<button class="btnDeploy" style="width:200px;height:100px;background-color:rgb(139, 187, 250);cursor:pointer;font-weight: bolder;">Deploy</button>`;
                this._html += `</div>`;
                return this._html;
            }

        }
    </script>
</body>
</html>